#include <stdio.h>
#include <stdlib.h>
#include <mpi.h>

#define ITERATIONS 10000
#define TAG 1
#define MSG_MAX 100

void run_process_even(int);
void run_process_odd(int);

int main (int argc, char **argv)
{
  int sz, myid;

  MPI_Init (&argc, &argv);

  MPI_Comm_rank (MPI_COMM_WORLD, &myid);

  if (myid % 2 == 0)
    run_process_even(myid);
  else
    run_process_odd(myid);

  MPI_Finalize ();
  exit (0);
}

void run_process_even(int my_id)
{
  double 
    start_time,
    end_time,
    diff,
    result,
    ** bandwidths = malloc(sizeof(double *) * MSG_MAX);

  int k;
  for(k=0; k<MSG_MAX; ++k)
  {
    bandwidths[k] = malloc(sizeof(double) * ITERATIONS);
  }  

  MPI_Status status;

  int msg_sz;
  for (msg_sz=0; msg_sz<MSG_MAX; ++msg_sz)
  { 
    double *messages = malloc(sizeof(double) * (msg_sz+1));
    int i;
    for(i=0; i<ITERATIONS; ++i)
    {
      for(j=0; j<msg_sz; ++j)
        messages[j] = *start_time;
      
      start_time = MPI_Wtime();
      MPI_Send(&messages, 1, MPI_DOUBLE, my_id+1, TAG, 
MPI_COMM_WORLD); 
      MPI_Recv(&result, 1, MPI_DOUBLE, my_id+1, TAG, MPI_COMM_WORLD, 
&status);
      end_time = MPI_Wtime();
      diff = end_time - result;
      bandwidths[msg_sz][i] = diff;
    }
    free(messages);
  }

  double total = 0.0;

  for(msg_sz=0; msg_sz<MSG_MAX; ++msg_sz)
  {
    total = 0.0;
    for (i=0; i<ITERATIONS; ++i)
    {
      total += bandwidths[msg_sz][i];
    }
    printf("average bandwidth for p%d sz %d: %e\n", my_id, msg_sz, 
msg_sz * sizeof(double) / (total / ITERATIONS));
  }

  free(bandwidths);
}



void run_process_odd(int my_id)
{
  double 
    start_time,
    end_time,
    diff,
    result,
    * latencies = malloc(sizeof(double) * ITERATIONS);

  MPI_Status status;

  int i;
  for(i=0; i<ITERATIONS; ++i)
  {
    MPI_Recv(&result, 1, MPI_DOUBLE, my_id-1, TAG, MPI_COMM_WORLD, &status);
    end_time = MPI_Wtime();
    start_time = MPI_Wtime();
    MPI_Send(&start_time, 1, MPI_DOUBLE, my_id-1, TAG, MPI_COMM_WORLD); 
    diff = end_time - result;
    latencies[i] = diff;
  }

  double total = 0.0;

  for(i=0; i<ITERATIONS; ++i)
  {
    total += latencies[i];
  }
  printf("average latency for p%d: %e\n", my_id, total / ITERATIONS);

  free(latencies);
}
